<!DOCTYPE HTML>
<html lang="en" class="ayu" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>findOneAndUpdate functions - Lesan</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="./css/animation-bench.css">
        <link rel="stylesheet" href="./css/styles.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('ayu')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">User Guide</li><li class="chapter-item expanded "><a href="installation.html"><strong aria-hidden="true">1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="getting_started.html"><strong aria-hidden="true">2.</strong> Getting started</a></li><li class="chapter-item expanded "><a href="add_relation.html"><strong aria-hidden="true">3.</strong> Add relation</a></li><li class="chapter-item expanded "><a href="add_more_relation.html"><strong aria-hidden="true">4.</strong> Add more relation</a></li><li class="chapter-item expanded "><a href="mannage_relations.html"><strong aria-hidden="true">5.</strong> Mannage relations</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="add_relation_fn.html"><strong aria-hidden="true">5.1.</strong> addRelation function</a></li><li class="chapter-item expanded "><a href="remove_relation_fn.html"><strong aria-hidden="true">5.2.</strong> removeRelation function</a></li><li class="chapter-item expanded "><a href="what_is_the_relationship.html"><strong aria-hidden="true">5.3.</strong> What is the relationship really?</a></li></ol></li><li class="chapter-item expanded "><a href="findOne_and_find_fn.html"><strong aria-hidden="true">6.</strong> findOne and find functions</a></li><li class="chapter-item expanded "><a href="aggregation_fn.html"><strong aria-hidden="true">7.</strong> aggregation functions</a></li><li class="chapter-item expanded "><a href="find_one_and_update_functions.html" class="active"><strong aria-hidden="true">8.</strong> findOneAndUpdate functions</a></li><li class="chapter-item expanded "><a href="delete_one_fn.html"><strong aria-hidden="true">9.</strong> deleteOne functions</a></li><li class="chapter-item expanded "><a href="insert_many_fn.html"><strong aria-hidden="true">10.</strong> insertMany functions</a></li><li class="chapter-item expanded "><a href="playground.html"><strong aria-hidden="true">11.</strong> Playground</a></li><li class="chapter-item expanded "><a href="request_flow.html"><strong aria-hidden="true">12.</strong> Request flow in Lesan</a></li><li class="chapter-item expanded "><a href="leasan_vs_graphql.html"><strong aria-hidden="true">13.</strong> Lesan vs GraphQL</a></li><li class="chapter-item expanded "><a href="all_advantages_of_lesan.html"><strong aria-hidden="true">14.</strong> All the advantages of Lesan</a></li><li class="chapter-item expanded affix "><li class="part-title">Advanced Guide</li><li class="chapter-item expanded "><a href="an_advanced_project.html"><strong aria-hidden="true">15.</strong> Implement an advanced project</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="advanced_general_description.html"><strong aria-hidden="true">15.1.</strong> General description</a></li><li class="chapter-item expanded "><a href="advanced_nx_config.html"><strong aria-hidden="true">15.2.</strong> nx configuration</a></li><li class="chapter-item expanded "><a href="folder_structure.html"><strong aria-hidden="true">15.3.</strong> Folder Structure</a></li><li class="chapter-item expanded "><a href="microservice-monolithic.html"><strong aria-hidden="true">15.4.</strong> Microservice or Monolithic</a></li></ol></li><li class="chapter-item expanded "><a href="manage_replica.html"><strong aria-hidden="true">16.</strong> Manage replica</a></li><li class="chapter-item expanded affix "><li class="part-title">Lesan Philosophy</li><li class="chapter-item expanded "><a href="Receiving_Data.html"><strong aria-hidden="true">17.</strong> Receiving Data</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Previous_methods_and_the_main_challenge.html"><strong aria-hidden="true">17.1.</strong> Previous methods and the main challenge</a></li><li class="chapter-item expanded "><a href="Lesan's_Solution_For_How_To_Communicate_Between_The_Server_And_The_Client.html"><strong aria-hidden="true">17.2.</strong> Lesan's Solution For How To Communicate Between The Server And The Client</a></li></ol></li><li class="chapter-item expanded "><a href="Why_NoSQL.html"><strong aria-hidden="true">18.</strong> Why noSQL?</a></li><li class="chapter-item expanded "><a href="Queuing_data_changes.html"><strong aria-hidden="true">19.</strong> Queuing data changes</a></li><li class="chapter-item expanded "><a href="CSR_SSR_or_SSG_content.html"><strong aria-hidden="true">20.</strong> CSR, SSR or SSG content</a></li><li class="chapter-item expanded "><a href="Penetration_Into_Depths.html"><strong aria-hidden="true">21.</strong> Penetration Into Depths</a></li><li class="chapter-item expanded "><a href="Microservice.html"><strong aria-hidden="true">22.</strong> Microservice</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Lesan_solution.html"><strong aria-hidden="true">22.1.</strong> Lesan solution</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Structures</li><li class="chapter-item expanded "><a href="Schemas.html"><strong aria-hidden="true">23.</strong> Schemas</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Pure_Structure_In_Schema.html"><strong aria-hidden="true">23.1.</strong> Pure Structure In Schema</a></li></ol></li><li class="chapter-item expanded "><a href="The_InRelation_Structure_In_Schema.html"><strong aria-hidden="true">24.</strong> The InRelation Structure In Schema</a></li><li class="chapter-item expanded "><a href="The_structure_of_OutRelation_in_the_schema.html"><strong aria-hidden="true">25.</strong> The structure of OutRelation in the schema</a></li><li class="chapter-item expanded "><a href="The_structure_of_embed_in_the_schema.html"><strong aria-hidden="true">26.</strong> The structure of embed in the schema</a></li><li class="chapter-item expanded "><a href="The_structure_of_Struct_in_the_schema.html"><strong aria-hidden="true">27.</strong> The structure of Struct in the schema</a></li><li class="chapter-item expanded "><a href="runServer_(web_server_structure).html"><strong aria-hidden="true">28.</strong> runServer (web server structure)</a></li><li class="chapter-item expanded "><a href="Request_processing.html"><strong aria-hidden="true">29.</strong> Request processing</a></li><li class="chapter-item expanded "><a href="Dynamic_structure.html"><strong aria-hidden="true">30.</strong> Dynamic structure</a></li><li class="chapter-item expanded "><a href="Static_structure.html"><strong aria-hidden="true">31.</strong> Static structure</a></li><li class="chapter-item expanded affix "><li class="part-title">API Reference</li><li class="chapter-item expanded "><a href="api/lesan_fn.html"><strong aria-hidden="true">32.</strong> lesan</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/schemas/schemas_fn.html"><strong aria-hidden="true">32.1.</strong> schemas</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/schemas/schemaFns/schemaFns_fn.html"><strong aria-hidden="true">32.1.1.</strong> schemaFns</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/schemas/schemaFns/getSchemas_fn.html"><strong aria-hidden="true">32.1.1.1.</strong> getSchemas</a></li><li class="chapter-item expanded "><a href="api/schemas/schemaFns/getPureOfMainRelations_fn.html"><strong aria-hidden="true">32.1.1.2.</strong> getPureOfMainRelations</a></li><li class="chapter-item expanded "><a href="api/schemas/schemaFns/getSchema_fn.html"><strong aria-hidden="true">32.1.1.3.</strong> getSchema</a></li><li class="chapter-item expanded "><a href="api/schemas/schemaFns/getPureSchema_fn.html"><strong aria-hidden="true">32.1.1.4.</strong> getPureSchema</a></li><li class="chapter-item expanded "><a href="api/schemas/schemaFns/getPureFromMainRelations_fn.html"><strong aria-hidden="true">32.1.1.5.</strong> getPureFromMainRelations</a></li><li class="chapter-item expanded "><a href="api/schemas/schemaFns/getPureFromRelatedRelations_fn.html"><strong aria-hidden="true">32.1.1.6.</strong> getPureFromRelatedRelations</a></li><li class="chapter-item expanded "><a href="api/schemas/schemaFns/createEmbedded_fn.html"><strong aria-hidden="true">32.1.1.7.</strong> createEmbedded</a></li><li class="chapter-item expanded "><a href="api/schemas/schemaFns/createStruct_fn.html"><strong aria-hidden="true">32.1.1.8.</strong> createStruct</a></li><li class="chapter-item expanded "><a href="api/schemas/schemaFns/getSchemasKeys_fn.html"><strong aria-hidden="true">32.1.1.9.</strong> getSchemasKeys</a></li></ol></li><li class="chapter-item expanded "><a href="api/schemas/mainRelationsFns/mainRelations_Fns.html"><strong aria-hidden="true">32.1.2.</strong> mainRelationsFns</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/schemas/mainRelationsFns/getMainRelations_fn.html"><strong aria-hidden="true">32.1.2.1.</strong> getMainRelations</a></li></ol></li><li class="chapter-item expanded "><a href="api/schemas/relatedRelationFns/relatedRelation_Fns.html"><strong aria-hidden="true">32.1.3.</strong> relatedRelationFns</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/schemas/relatedRelationFns/getRelatedRelations_fn.html"><strong aria-hidden="true">32.1.3.1.</strong> getRelatedRelations</a></li></ol></li><li class="chapter-item expanded "><a href="api/schemas/pureFns/pure_Fns.html"><strong aria-hidden="true">32.1.4.</strong> pureFns</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/schemas/pureFns/addPureModel_Fns.html"><strong aria-hidden="true">32.1.4.1.</strong> addPureModel</a></li><li class="chapter-item expanded "><a href="api/schemas/pureFns/getPureModel_Fns.html"><strong aria-hidden="true">32.1.4.2.</strong> getPureModel</a></li><li class="chapter-item expanded "><a href="api/schemas/pureFns/getPureModelByNameAndKey_Fns.html"><strong aria-hidden="true">32.1.4.3.</strong> getPureModelByNameAndKey</a></li></ol></li><li class="chapter-item expanded "><a href="api/schemas/relationFns/relation_Fns.html"><strong aria-hidden="true">32.1.5.</strong> relationFns</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/schemas/relationFns/getRelation_Fns.html"><strong aria-hidden="true">32.1.5.1.</strong> getRelation</a></li></ol></li><li class="chapter-item expanded "><a href="api/schemas/selectStructFns/selectStructFns_Fns.html"><strong aria-hidden="true">32.1.6.</strong> selectStructFns</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/schemas/selectStructFns/fieldType_Fn.html"><strong aria-hidden="true">32.1.6.1.</strong> fieldType</a></li><li class="chapter-item expanded "><a href="api/schemas/selectStructFns/decreaseIterate_Fn.html"><strong aria-hidden="true">32.1.6.2.</strong> decreaseIterate</a></li><li class="chapter-item expanded "><a href="api/schemas/selectStructFns/checkRelation_Fn.html"><strong aria-hidden="true">32.1.6.3.</strong> checkRelation</a></li><li class="chapter-item expanded "><a href="api/schemas/selectStructFns/selectStruct_Fn.html"><strong aria-hidden="true">32.1.6.4.</strong> selectStruct</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="api/acts/acts_fn.html"><strong aria-hidden="true">32.2.</strong> acts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/acts/setAct/setAct_Fns.html"><strong aria-hidden="true">32.2.1.</strong> setAct</a></li><li class="chapter-item expanded "><a href="api/acts/getServiceKeys/getServiceKeys_Fns.html"><strong aria-hidden="true">32.2.2.</strong> getServiceKeys</a></li><li class="chapter-item expanded "><a href="api/acts/getActs/getActs_Fns.html"><strong aria-hidden="true">32.2.3.</strong> getActs</a></li><li class="chapter-item expanded "><a href="api/acts/getActsKeys/getActsKeys_Fns.html"><strong aria-hidden="true">32.2.4.</strong> getActsKeys</a></li><li class="chapter-item expanded "><a href="api/acts/getActKeys/getActKeys_Fns.html"><strong aria-hidden="true">32.2.5.</strong> getActKeys</a></li><li class="chapter-item expanded "><a href="api/acts/getAct/getAct_Fns.html"><strong aria-hidden="true">32.2.6.</strong> getAct</a></li><li class="chapter-item expanded "><a href="api/acts/getAtcsWithServices/getAtcsWithServices_Fns.html"><strong aria-hidden="true">32.2.7.</strong> getAtcsWithServices</a></li><li class="chapter-item expanded "><a href="api/acts/getMainActs/getMainActs_Fns.html"><strong aria-hidden="true">32.2.8.</strong> getMainActs</a></li><li class="chapter-item expanded "><a href="api/acts/getMainAct/getMainAct_Fns.html"><strong aria-hidden="true">32.2.9.</strong> getMainAct</a></li><li class="chapter-item expanded "><a href="api/acts/setService/setService_Fns.html"><strong aria-hidden="true">32.2.10.</strong> setService</a></li><li class="chapter-item expanded "><a href="api/acts/getService/getService_Fns.html"><strong aria-hidden="true">32.2.11.</strong>   getService</a></li></ol></li><li class="chapter-item expanded "><a href="api/odm/odm_fn.html"><strong aria-hidden="true">32.3.</strong> odm</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/odm/setDb/setDb_Fns.html"><strong aria-hidden="true">32.3.1.</strong> setDb</a></li><li class="chapter-item expanded "><a href="api/odm/getCollection/getCollection_Fns.html"><strong aria-hidden="true">32.3.2.</strong> getCollection</a></li><li class="chapter-item expanded "><a href="api/odm/newModel/newModel_Fns.html"><strong aria-hidden="true">32.3.3.</strong> newModel</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/odm/newModel/find_Fns.html"><strong aria-hidden="true">32.3.3.1.</strong> find</a></li><li class="chapter-item expanded "><a href="api/odm/newModel/findOne_Fns.html"><strong aria-hidden="true">32.3.3.2.</strong> findOne</a></li><li class="chapter-item expanded "><a href="api/odm/newModel/insertOne_Fns.html"><strong aria-hidden="true">32.3.3.3.</strong> insertOne</a></li><li class="chapter-item expanded "><a href="api/odm/newModel/insertMany_Fns.html"><strong aria-hidden="true">32.3.3.4.</strong> insertMany</a></li><li class="chapter-item expanded "><a href="api/odm/newModel/addRelation_Fns.html"><strong aria-hidden="true">32.3.3.5.</strong> addRelation</a></li><li class="chapter-item expanded "><a href="api/odm/newModel/removeRelation_Fns.html"><strong aria-hidden="true">32.3.3.6.</strong> removeRelation</a></li><li class="chapter-item expanded "><a href="api/odm/newModel/findOneAndUpdate_Fns.html"><strong aria-hidden="true">32.3.3.7.</strong> findOneAndUpdate</a></li><li class="chapter-item expanded "><a href="api/odm/newModel/deleteOne_Fns.html"><strong aria-hidden="true">32.3.3.8.</strong> deleteOne</a></li><li class="chapter-item expanded "><a href="api/odm/newModel/aggregation_Fns.html"><strong aria-hidden="true">32.3.3.9.</strong> aggregation</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="api/context/contextFns_fn.html"><strong aria-hidden="true">32.4.</strong> contextFns</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/context/getContextModel/getContextModel_Fns.html"><strong aria-hidden="true">32.4.1.</strong> getContextModel</a></li><li class="chapter-item expanded "><a href="api/context/setContext/setContext_Fns.html"><strong aria-hidden="true">32.4.2.</strong> setContext</a></li><li class="chapter-item expanded "><a href="api/context/getContextModel/addContext_Fns.html"><strong aria-hidden="true">32.4.3.</strong> addContext</a></li><li class="chapter-item expanded "><a href="api/context/getContextModel/addContexts_Fns.html"><strong aria-hidden="true">32.4.4.</strong> addContexts</a></li><li class="chapter-item expanded "><a href="api/context/getContextModel/addReqToContext_Fns.html"><strong aria-hidden="true">32.4.5.</strong> addReqToContext</a></li><li class="chapter-item expanded "><a href="api/context/getContextModel/addHeaderToContext_Fns.html"><strong aria-hidden="true">32.4.6.</strong> addHeaderToContext</a></li><li class="chapter-item expanded "><a href="api/context/getContextModel/addBodyToContext_Fns.html"><strong aria-hidden="true">32.4.7.</strong> addBodyToContext</a></li></ol></li><li class="chapter-item expanded "><a href="api/runServer/runServer_fn.html"><strong aria-hidden="true">32.5.</strong> runServer</a></li><li class="chapter-item expanded "><a href="api/generateSchema/generateSchemTypes_fn.html"><strong aria-hidden="true">32.6.</strong> generateSchemTypes</a></li></ol></li><li class="chapter-item expanded "><a href="api/types/types.html"><strong aria-hidden="true">33.</strong> types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/types/schema/Tschemas.html"><strong aria-hidden="true">33.1.</strong> Tshemas types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/types/schema/IModel.html"><strong aria-hidden="true">33.1.1.</strong> IModel types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/types/schema/model/TRelation.html"><strong aria-hidden="true">33.1.1.1.</strong> TRelation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/types/schema/model/TRelation/RelationDataType.html"><strong aria-hidden="true">33.1.1.1.1.</strong> RelationDataType</a></li><li class="chapter-item expanded "><a href="api/types/schema/model/TRelation/RelationSortOrderType.html"><strong aria-hidden="true">33.1.1.1.2.</strong> RelationSortOrderType</a></li><li class="chapter-item expanded "><a href="api/types/schema/model/TRelation/TRelatedRelation.html"><strong aria-hidden="true">33.1.1.1.3.</strong> TRelatedRelation</a></li></ol></li><li class="chapter-item expanded "><a href="api/types/schema/model/IMainRelation.html"><strong aria-hidden="true">33.1.1.2.</strong> IMainRelation</a></li><li class="chapter-item expanded "><a href="api/types/schema/model/IRelatedRelation.html"><strong aria-hidden="true">33.1.1.3.</strong> IRelatedRelation</a></li></ol></li><li class="chapter-item expanded "><a href="api/types/schema/RelationType.html"><strong aria-hidden="true">33.1.2.</strong> RelationType</a></li><li class="chapter-item expanded "><a href="api/types/schema/IPureFields.html"><strong aria-hidden="true">33.1.3.</strong> IPureFields</a></li><li class="chapter-item expanded "><a href="api/types/schema/CheckRelation.html"><strong aria-hidden="true">33.1.4.</strong> CheckRelation</a></li><li class="chapter-item expanded "><a href="api/types/schema/Iterate.html"><strong aria-hidden="true">33.1.5.</strong> Iterate</a></li></ol></li><li class="chapter-item expanded "><a href="api/types/Services/Services.html"><strong aria-hidden="true">33.2.</strong> Services types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/types/Services/Acts.html"><strong aria-hidden="true">33.2.1.</strong> Acts types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/types/Services/Acts/Act.html"><strong aria-hidden="true">33.2.1.1.</strong> Act</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/types/Services/Acts/Act/ActFn.html"><strong aria-hidden="true">33.2.1.1.1.</strong> ActFn</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/types/Services/Acts/Act/ActFn/TLesanBody.html"><strong aria-hidden="true">33.2.1.1.1.1.</strong> TLesanBody</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/types/Services/Acts/Act/ActFn/TLesanBody/Details.html"><strong aria-hidden="true">33.2.1.1.1.1.1.</strong> Details</a></li></ol></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><a href="api/types/Services/ActInp.html"><strong aria-hidden="true">33.2.2.</strong> ActInp</a></li></ol></li><li class="chapter-item expanded "><a href="api/types/odm.html"><strong aria-hidden="true">33.3.</strong> odm types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/types/TInsertRelations.html"><strong aria-hidden="true">33.3.1.</strong> TInsertRelations</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/types/TInsertRelations/IRelationsFileds.html"><strong aria-hidden="true">33.3.1.1.</strong> IRelationsFileds</a></li></ol></li><li class="chapter-item expanded "><a href="api/types/aggregation/projection/projection.html"><strong aria-hidden="true">33.3.2.</strong> projection</a></li></ol></li><li class="chapter-item expanded "><a href="api/types/context.html"><strong aria-hidden="true">33.4.</strong> context types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/types/context/LesanContenxt.html"><strong aria-hidden="true">33.4.1.</strong> LesanContenxt</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Lesan</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/MiaadTeam/lesan" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/MiaadTeam/lesan/tree/main/pages/src/find_one_and_update_functions.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="findoneandupdate-functions"><a class="header" href="#findoneandupdate-functions"><code>findOneAndUpdate</code> functions</a></h1>
<p>Updating is the most challenging issue in <strong>Lesan</strong>. Because by updating <code>one</code> document, <code>thousands</code> or maybe <code>millions</code> of other documents may also be updated. Don't worry, this is done automatically by <strong>Lesan</strong>. And also for complex scenarios where <code>millions</code> of documents need to be updated, we have created various solutions.</p>
<p>Let's explore a few scenarios.</p>
<ul>
<li>Best case "Update <code>a user</code>":</li>
</ul>
<pre><code class="language-ts">const updateUserValidator = () =&gt; {
  return object({
    set: object({
      _id: objectIdValidation,
      name: optional(string()),
      age: optional(number()),
    }),
    get: coreApp.schemas.selectStruct("user", 1),
  });
};
const updateUser: ActFn = async (body) =&gt; {
  const { name, age, _id } = body.details.set;
  const setObj: { name?: string; age?: number } = {};
  name &amp;&amp; (setObj.name = name);
  age &amp;&amp; (setObj.age = age);

  return await users.findOneAndUpdate({
    filter: { _id: new ObjectId(_id) },
    projection: body.details.get,
    update: { $set: setObj },
  });
};
coreApp.acts.setAct({
  schema: "user",
  actName: "updateUser",
  validator: updateUserValidator(),
  fn: updateUser,
});
</code></pre>
<p>When we were defining <code>user</code> relationships, we said that each user has a relationship with the <code>cities</code> he lived in. In defining this relationship, we said that we store the last <code>50 users</code> who lived in these <code>cities</code> in the city table. So it is possible that the <code>user</code> who is updated may be in the list of these 50 users in <code>several cities</code>. So we have to <code>find</code> the cities where this user lives and<code> update</code> the list of <code>users</code> in those <code>cities</code>.<br />
If we set the <code>order</code> of saving this list of 50 items based on a <code>field</code> from the <code>user</code> and the <code>same field</code> has been <code>updated</code>, the story will be a little more complicated. Because it is possible that if this <code>user</code> is in the list of <code>50</code>, he will be <code>removed</code> from this list due to the updating of this <code>field</code> and another <code>user</code> who has suitable conditions will replace this <code>user</code>. For more information please read <a href="./what_is_the_relationship.html">here</a>.</p>
<p>All things will be the same for the <code>country</code>.</p>
<p>You can find full example <a href="https://raw.githubusercontent.com/MiaadTeam/lesan/main/examples/document/08-1-findOneAndUpdate.ts">here</a> and test the <code>findOneAndUpdate</code> method in local computer.</p>
<p>before executing <code>main</code> → <code>user</code> → <code>updateUser</code>:
<img src="https://github.com/MiaadTeam/lesan/assets/6236123/90f80569-4e19-4274-ba26-2d5c517698b5" alt="db-user-update" /></p>
<p>executing <code>main</code> → <code>user</code> → <code>updateUser</code>:
<img src="https://github.com/MiaadTeam/lesan/assets/6236123/dc9a32f6-db31-46fa-8f55-9ffc9e3aaabc" alt="db-user-updating" /></p>
<p>after executing <code>main</code> → <code>user</code> → <code>updateUser</code>:
<img src="https://github.com/MiaadTeam/lesan/assets/6236123/1d6408ba-327f-4987-bebd-dd345618cdf0" alt="db-user-updated" /></p>
<h3 id="add-e2e-test"><a class="header" href="#add-e2e-test">Add E2E Test</a></h3>
<p>Like before, for adding <code>updateUser</code> request to E2E section you should click on the e2e button (like bottom picture) to add your request to E2E section.</p>
<img width="1680" alt="e2e sequence" src="https://github.com/MiaadTeam/lesan/assets/96171913/fae58c10-f792-4041-89ca-186dc89bcee1">
<p>Then, in the E2E section and <code>updateUser</code> sequence, you should <em>replace</em> the <strong>user id</strong> that you set capture in <em>own sequence</em> with <em>default</em> <strong>user id</strong>. <em>default</em> <strong>user id</strong> in <code>updateUser</code> sequence is like below picture.</p>
<img width="1680" alt="e2e sequence" src="https://github.com/MiaadTeam/lesan/assets/96171913/7541ab72-7b04-44ab-82d4-3a54cd65589d">
<p>The <em>replaced</em> <strong>user id</strong> is like below picture.</p>
<img width="1680" alt="e2e sequence" src="https://github.com/MiaadTeam/lesan/assets/96171913/d3278025-daa9-47a2-b441-df8c9b52cec0">
<ul>
<li>Worse case "Update <code>a country</code>":</li>
</ul>
<pre><code class="language-ts">const updateCountryValidator = () =&gt; {
  return object({
    set: object({
      _id: objectIdValidation,
      name: optional(string()),
      abb: optional(string()),
      population: optional(number()),
    }),
    get: coreApp.schemas.selectStruct("country", 1),
  });
};
const updateCountry: ActFn = async (body) =&gt; {
  const { name, abb, population, _id } = body.details.set;
  const setObj: { name?: string; abb?: string; population?: number } = {};
  name &amp;&amp; (setObj.name = name);
  abb &amp;&amp; (setObj.abb = abb);
  population &amp;&amp; (setObj.population = population);

  return await countries.findOneAndUpdate({
    filter: { _id: new ObjectId(_id) },
    projection: body.details.get,
    update: { $set: setObj },
  });
};
coreApp.acts.setAct({
  schema: "country",
  actName: "updateCountry",
  validator: updateCountryValidator(),
  fn: updateCountry,
});
</code></pre>
<p>If the <code>country</code> is updated in a real scenario, the number of documents that need to be updated along with the country is likely to be <code>very large</code>. Because all <code>users</code> and <code>cities</code> of that country must be updated.</p>
<p>You can find full example <a href="https://raw.githubusercontent.com/MiaadTeam/lesan/main/examples/document/08-2-findOneAndUpdate.ts">here</a> and test the <code>findOneAndUpdate</code> method in local computer.</p>
<p>before executing <code>main</code> → <code>country</code> → <code>updateCountry</code>:
<img src="https://github.com/MiaadTeam/lesan/assets/6236123/69bdeb8c-8c30-4af8-bfc4-eca2b04c8ff3" alt="before-update-country" /></p>
<p>executing <code>main</code> → <code>country</code> → <code>updateCountry</code>:
<img src="https://github.com/MiaadTeam/lesan/assets/6236123/ff6fdfb8-d074-45c7-836a-1deb81f15172" alt="updating-country" /></p>
<p>after executing <code>main</code> → <code>country</code> → <code>updateCountry</code>:
<img src="https://github.com/MiaadTeam/lesan/assets/6236123/e749a816-31cd-47da-815f-491cbbecd931" alt="after-update-country" /></p>
<h3 id="add-e2e-test-1"><a class="header" href="#add-e2e-test-1">Add E2E Test</a></h3>
<p>Like before, for adding <code>updateCountry</code> request to E2E section you should click on the e2e button (like bottom picture) to add your request to E2E section.</p>
<img width="1680" alt="e2e sequence" src="https://github.com/MiaadTeam/lesan/assets/96171913/fae58c10-f792-4041-89ca-186dc89bcee1">
<p>Then, in the E2E section and <code>updateCountry</code> sequence, you should <em>replace</em> the <strong>country id</strong> that you set capture in <em>own sequence</em> with <em>default</em> <strong>country id</strong>. <em>default</em> <strong>country id</strong> in <code>updateCountry</code> sequence is like below picture.</p>
<img width="1680" alt="e2e sequence" src="https://github.com/MiaadTeam/lesan/assets/96171913/cb6fded6-6b32-47b9-9ea0-2e14d4c51880">
<p>The <em>replaced</em> <strong>country id</strong> is like below picture.</p>
<img width="1680" alt="e2e sequence" src="https://github.com/MiaadTeam/lesan/assets/96171913/0b395ae0-8d01-432f-ab65-3488511166c6">
<h2 id="lesans-solution-to-the-update-challenge"><a class="header" href="#lesans-solution-to-the-update-challenge">Lesan's solution to the update challenge</a></h2>
<p>As you have seen, we face a big problem for <code>updating</code> the <code>country</code> and <code>millions</code> of documents may need to be updated by updating <code>one</code> document. This is the biggest challenge in <strong>Lesan</strong> and we propose <code>3 solutions</code> to solve this problem:</p>
<h3 id="qq-solutions"><a class="header" href="#qq-solutions">QQ solutions</a></h3>
<p><code>QQ</code> stands for query queue, a queue of commands to be sent to the <code>database</code>. We use <code>QQ</code> to chunk <code>millions</code> of <code>updates</code>. In this way, we take a section of several hundred thousand that we guess should be updated immediately and perform the update, then we store the ID of the last updated document along with the necessary commands for updating in <code>QQ</code>. And we do another part of the update whenever hardware resources are low on contention.</p>
<h3 id="in-memmory-db-solutions"><a class="header" href="#in-memmory-db-solutions">In-memmory DB solutions</a></h3>
<p>Because we have <code>detailed</code> relationship information, we can know when sending information to the customer that the information sent has changes in <code>QQ</code>. As a result, by saving the changes in an <code>in-memory</code> database, we can correct the <code>sent</code> information in the same <code>RAM</code> and send it to the client, without changing the actual data in the <code>hard disk</code>.</p>
<h3 id="make-new-relation-solutions"><a class="header" href="#make-new-relation-solutions">Make new relation solutions</a></h3>
<p>Perhaps the most beautiful thing about database <code>relations</code> is here.<br />
In <code>Lesan</code>, after checking the data model, we can convert frequently changing fields into a <code>new relationship</code>.<br />
Going back to the previous example, our real problem was updating <code>a country</code> because <code>millions</code> of documents needed to be <code>updated</code>.<br />
In our example, each <code>country</code> had the following <code>pure</code> fields:</p>
<ul>
<li>name</li>
<li>abb</li>
<li>population</li>
</ul>
<p>The <code>name</code> and <code>abb</code> fields usually do not change, in fact, in our example, they never change, but the <code>population</code> field may change a lot, imagine that we want to have the updated <code>population</code> of each country every second, that is, all <code>countries</code> are updated every second. And by updating each country, all the <code>cities</code> and <code>users</code> belonging to that <code>country</code> must be updated. Well, this is almost impossible.<br />
But if we convert the <code>population</code> field into a <code>new schema</code> and create a <code>relationship</code> with the <code>country</code> for it, all problems will be solved.<br />
Pay attention to the following code:</p>
<pre><code class="language-ts">const populationPure = {
  population: number(),
  type: enums(["City", "Country"]),
};

const populationRelations = {
  country: {
    optional: false,
    schemaName: "country",
    type: "single" as RelationDataType,
    relatedRelations: {
      populations: {
        type: "multiple" as RelationDataType,
        limit: 50,
        sort: {
          field: "_id",
          order: "desc" as RelationSortOrderType,
        },
      },
    },
  },
  city: {
    optional: false,
    schemaName: "country",
    type: "single" as RelationDataType,
    relatedRelations: {
      populations: {
        type: "multiple" as RelationDataType,
        limit: 50,
        sort: {
          field: "_id",
          order: "desc" as RelationSortOrderType,
        },
      },
    },
  },
};

const populations = coreApp.odm.newModel(
  "population",
  populationPure,
  populationRelations
);
</code></pre>
<p>Now we can <code>remove</code> the <code>population</code> field from both the <code>pure</code> fields of the <code>city</code> and the <code>pure</code> fields of the <code>country</code>. But there is still the <code>population</code> field in both the <code>country</code> and the <code>city</code>, and we can write any type of <code>filter</code> or <code>sort</code> for the <code>city</code> and <code>country</code> schemas based on the <code>population</code>. Even better, now we have a list of the last 50 <code>population</code> records for each <code>country</code> and each <code>city</code>, and we can <code>find</code>, for example, <code>countries</code> that have added more than <code>100</code> people to their <code>population</code> in the last minute, without sending a <code>complex query</code> to the database.</p>
<p>And the most <strong>important</strong> thing is that now, with the <code>population</code> change, instead of <code>millions</code> of documents, only <code>two</code> documents change.<br />
Because to change the <code>population</code>, we make a <code>new record</code> for the <code>population</code> and store this new record only in the <code>country</code> or <code>city</code> that belongs to it in the <code>populations</code> list. And we no longer need to update <code>thousands</code> of <code>cities</code> or <code>millions</code> of <code>users</code>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="aggregation_fn.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="delete_one_fn.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="aggregation_fn.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="delete_one_fn.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
